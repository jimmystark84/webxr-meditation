<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Milky Way: Supernova Edition</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script>
      // MASTER CONTROLLER: Handles the Supernova and World State
      AFRAME.registerComponent('universe-engine', {
        init: function () {
          this.colors = [
            ['#00f2ff', '#7000ff', '#ff007b'], // Neon Nebula
            ['#ff9d00', '#ff4500', '#ffff00'], // Solar Flare
            ['#00ff8c', '#0044ff', '#ffffff']  // Deep Sea Space
          ];
          this.currentPalette = 0;
          this.generateWorld();
          
          // Trigger Supernova every 120 seconds
          setInterval(() => this.triggerSupernova(), 120000);
        },

        generateWorld: function () {
          const sceneEl = this.el;
          const palette = this.colors[this.currentPalette];
          
          // Clear existing crystals if any
          const oldCrystals = document.querySelectorAll('.cluster');
          oldCrystals.forEach(c => c.parentNode.removeChild(c));

          for (let i = 0; i < 200; i++) {
            let cluster = document.createElement('a-entity');
            cluster.classList.add('cluster');
            
            for (let j = 0; j < 8; j++) {
              let shard = document.createElement('a-cone');
              shard.setAttribute('radius-bottom', Math.random() * 0.5 + 0.2);
              shard.setAttribute('height', Math.random() * 5 + 1);
              shard.setAttribute('segments-radial', 6);
              shard.setAttribute('rotation', {x: Math.random()*360, y: Math.random()*360, z: Math.random()*360});

              let col = palette[Math.floor(Math.random() * palette.length)];
              shard.setAttribute('material', {
                color: col, emissive: col, emissiveIntensity: 2,
                metalness: 1, roughness: 0, transparent: true, opacity: 0.8
              });
              cluster.appendChild(shard);
            }

            cluster.setAttribute('position', {
              x: (Math.random() - 0.5) * 150,
              y: (Math.random() - 0.5) * 150,
              z: (Math.random() * -300)
            });

            cluster.setAttribute('animation', {
                property: 'rotation', to: '360 720 360', loop: true, 
                dur: 10000 + Math.random() * 20000, easing: 'linear'
            });

            sceneEl.appendChild(cluster);
          }
        },

        triggerSupernova: function () {
          const flash = document.querySelector('#flash');
          // Start the blinding white flash
          flash.setAttribute('animation', {
            property: 'material.opacity', from: 0, to: 1, dur: 3000, easing: 'easeInQuad'
          });

          setTimeout(() => {
            // Change palette and rebuild while screen is white
            this.currentPalette = (this.currentPalette + 1) % this.colors.length;
            this.generateWorld();
            
            // Fade flash back out
            flash.setAttribute('animation', {
              property: 'material.opacity', from: 1, to: 0, dur: 5000, easing: 'easeOutQuad'
            });
          }, 3500);
        }
      });

      // Drifting and wrapping logic
      AFRAME.registerComponent('infinite-vortex', {
        tick: function () {
          const cam = document.querySelector('#rig').object3D.position;
          this.el.childNodes.forEach(c => {
            if (c.object3D && c.object3D.position.z > cam.z + 20) {
              c.object3D.position.z = cam.z - 280;
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <a-scene universe-engine infinite-vortex renderer="bloom: true; exposure: 2.0; antialias: true;">
      
      <a-assets>
        <img id="milkyway" src="https://cdn.glitch.global/605e2a51-d45f-4d87-a285-9410ad350515/milkyway.jpg?v=1642610115682">
      </a-assets>

      <a-sphere id="flash" radius="2" material="color: white; shader: flat; side: double; opacity: 0; transparent: true" position="0 1.6 0"></a-sphere>

      <a-sky src="#milkyway" animation="property: rotation; to: 360 360 0; dur: 800000; loop: true; easing: linear"></a-sky>

      <a-entity animation="property: rotation; to: 0 360 0; dur: 100000; loop: true; easing: linear">
        <a-stars count="15000" radius="200" color="#fff"></a-stars>
      </a-entity>

      <a-entity id="rig" position="0 0 0" animation="property: position; to: 0 0 -5000; dur: 500000; easing: linear">
        <a-camera look-controls></a-camera>
      </a-entity>

      <a-light type="ambient" intensity="0.5"></a-light>
      <a-light type="point" intensity="3" position="0 2 -2" color="#fff"></a-light>

    </a-scene>
  </body>
</html>
