<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Milky Way: Solid Asteroids</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script>
      // COMPONENT: Procedural Solid Rock Geometry
      AFRAME.registerComponent('solid-rock', {
        init: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;

          const positionAttribute = mesh.geometry.getAttribute('position');
          const vertex = new THREE.Vector3();

          // We use a "Seed" approach so the rocks stay solid but jagged
          for (let i = 0; i < positionAttribute.count; i++) {
            vertex.fromBufferAttribute(positionAttribute, i);
            
            // Stronger, sharper displacement for a "solid" look
            const noise = (Math.random() - 0.5) * 0.5; 
            vertex.multiplyScalar(1 + noise);
            
            positionAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
          }
          positionAttribute.needsUpdate = true;
          mesh.geometry.computeVertexNormals(); 
        }
      });

      AFRAME.registerComponent('universe-engine', {
        init: function () {
          this.generateWorld();
          this.timer = 0;
        },

        tick: function (t, dt) {
          this.timer += dt;
          if (this.timer >= 45000) { // Every 45 seconds for a faster cycle
            this.timer = 0;
            this.triggerSupernova();
          }
        },

        generateWorld: function () {
          const sceneEl = this.el;
          document.querySelectorAll('.asteroid').forEach(c => c.parentNode.removeChild(c));

          for (let i = 0; i < 90; i++) {
            let rock = document.createElement('a-entity');
            rock.classList.add('asteroid');
            
            // Detail:1 keeps it "low-poly" and sharp/solid looking
            rock.setAttribute('geometry', {
              primitive: 'icosahedron',
              radius: Math.random() * 2 + 0.8,
              detail: 1 
            });

            rock.setAttribute('solid-rock', '');

            // LIGHTER COLOUR: Lighter grey/concrete tone to pop against space
            rock.setAttribute('material', {
              color: '#A9A9A9', 
              roughness: 0.8, 
              metalness: 0.2,
              flatShading: true // This makes the faces look "hard" and solid
            });

            rock.setAttribute('position', {
              x: (Math.random()-0.5)*160, 
              y: (Math.random()-0.5)*120, 
              z: (Math.random()*-300)
            });

            rock.setAttribute('animation', {
              property: 'rotation', 
              to: `${Math.random()*360} 360 ${Math.random()*360}`, 
              loop: true, 
              dur: 60000 + Math.random() * 40000, 
              easing: 'linear'
            });

            sceneEl.appendChild(rock);
          }
        },

        triggerSupernova: function () {
          const flash = document.querySelector('#flash');
          // Fast fade in
          flash.setAttribute('animation', {property: 'material.opacity', from: 0, to: 1, dur: 1500});
          
          setTimeout(() => {
            this.generateWorld();
            // Slow fade out
            flash.setAttribute('animation', {property: 'material.opacity', from: 1, to: 0, dur: 3000});
          }, 1600);
        }
      });
    </script>
  </head>
  <body>
    <a-scene universe-engine renderer="colorManagement: true; exposure: 1.3; antialias: true;">
      <a-assets>
        <img id="milkyway" src="milkyway.jpg" crossorigin="anonymous">
      </a-assets>

      <a-sphere id="flash" radius="20" material="color: #ffffff; shader: flat; side: double; opacity: 0; transparent: true" position="0 1.6 0"></a-sphere>

      <a-sky src="#milkyway" rotation="0 -90 0"></a-sky>

      <a-entity id="rig" position="0 0 0" animation="property: position; to: 0 0 -8000; dur: 1000000; easing: linear">
        <a-camera look-controls fov="80"></a-camera>
        <a-entity oculus-touch-controls="hand: left"></a-entity>
        <a-entity oculus-touch-controls="hand: right"></a-entity>
      </a-entity>

      <a-light type="directional" intensity="2.8" position="10 10 10" target="#rig"></a-light>
      <a-light type="ambient" intensity="0.2" color="#fff"></a-light>

    </a-scene>
  </body>
</html>
