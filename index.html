<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Milky Way: Realistic Asteroids</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script>
      // COMPONENT: Creates the "Craters" and rough texture procedurally
      AFRAME.registerComponent('asteroid-geometry', {
        init: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh) return;

          // We grab the vertices of the shape and "perturb" them
          const positionAttribute = mesh.geometry.getAttribute('position');
          const vertex = new THREE.Vector3();

          for (let i = 0; i < positionAttribute.count; i++) {
            vertex.fromBufferAttribute(positionAttribute, i);
            
            // This math creates random "bumps" and "divots" (craters)
            const noise = (Math.random() - 0.5) * 0.4; 
            vertex.multiplyScalar(1 + noise);
            
            positionAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
          }
          positionAttribute.needsUpdate = true;
          mesh.geometry.computeVertexNormals(); // Fixes the lighting for the new bumps
        }
      });

      AFRAME.registerComponent('universe-engine', {
        init: function () {
          this.generateWorld();
          this.timer = 0;
        },

        tick: function (t, dt) {
          this.timer += dt;
          if (this.timer >= 60000) { 
            this.timer = 0;
            this.triggerSupernova();
          }
        },

        generateWorld: function () {
          const sceneEl = this.el;
          document.querySelectorAll('.asteroid').forEach(c => c.parentNode.removeChild(c));

          for (let i = 0; i < 80; i++) {
            let rock = document.createElement('a-entity');
            rock.classList.add('asteroid');
            
            // Use Icosahedron with detail:2 for enough "resolution" to see craters
            rock.setAttribute('geometry', {
              primitive: 'icosahedron',
              radius: Math.random() * 2 + 1,
              detail: 2 
            });

            // Apply our custom "Crater" math
            rock.setAttribute('asteroid-geometry', '');

            // Material inspired by your image: Dark grey, very rough
            rock.setAttribute('material', {
              color: '#333333',
              roughness: 1.0, 
              metalness: 0.0,
              sphericalEnvMap: '#milkyway',
              envMapIntensity: 0.2 // Very subtle star reflections
            });

            rock.setAttribute('position', {
              x: (Math.random()-0.5)*180, 
              y: (Math.random()-0.5)*120, 
              z: (Math.random()*-300)
            });

            // Random tumbling
            rock.setAttribute('animation', {
              property: 'rotation', 
              to: `${Math.random()*360} 360 ${Math.random()*360}`, 
              loop: true, 
              dur: 50000 + Math.random() * 50000, 
              easing: 'linear'
            });

            sceneEl.appendChild(rock);
          }
        },

        triggerSupernova: function () {
          const flash = document.querySelector('#flash');
          if (!flash) return;
          flash.setAttribute('animation', {property: 'material.opacity', from: 0, to: 1, dur: 2000});
          setTimeout(() => {
            this.generateWorld();
            flash.setAttribute('animation', {property: 'material.opacity', from: 1, to: 0, dur: 4000});
          }, 2100);
        }
      });
    </script>
  </head>
  <body>
    <a-scene universe-engine renderer="colorManagement: true; exposure: 1.0;">
      <a-assets>
        <img id="milkyway" src="milkyway.jpg" crossorigin="anonymous">
      </a-assets>

      <a-sphere id="flash" radius="15" material="color: white; shader: flat; side: double; opacity: 0; transparent: true" position="0 1.6 0"></a-sphere>

      <a-sky src="#milkyway" rotation="0 -90 0"></a-sky>

      <a-entity id="rig" position="0 0 0" animation="property: position; to: 0 0 -10000; dur: 1200000; easing: linear">
        <a-camera look-controls fov="80"></a-camera>
      </a-entity>

      <a-light type="directional" intensity="2.5" position="-10 10 5" target="#rig"></a-light>
      <a-light type="ambient" intensity="0.1" color="#1a1a33"></a-light>

    </a-scene>
  </body>
</html>
